// SPDX-License-Identifier: GPL-2.0-or-later
// Copyright (c) 2021, Iskren Chernev <iskren.chernev@gmail.com>
// Copyright (c) 2021, Alexey Minnekhanov <alexeymin@postmarketos.org>
// Copyright (c) 2021, The Linux Foundation. All rights reserved.

#include <linux/backlight.h>
#include <linux/delay.h>
#include <linux/gpio/consumer.h>
#include <linux/module.h>
#include <linux/of.h>
#include <linux/regulator/consumer.h>

#include <drm/drm_mipi_dsi.h>
#include <drm/drm_modes.h>
#include <drm/drm_panel.h>

#include <video/mipi_display.h>

enum s6e3fa2_panel_subtype {
	PANEL_S6E3FA2 = 0,
	PANEL_EA8064G = 1,
	PANEL_UNKNOWN
};

#define ENABLE_LCD_ID_AUTODETECT
#define LCD_ID_S6E3FA2	0x602813
#define LCD_ID_EA8064G	0x622872

/* Maximum brightness level */
#define S6E3FA2_NUM_GAMMA_LEVELS	60
#define S6E3FA2_MAX_BRIGHTNESS		(S6E3FA2_NUM_GAMMA_LEVELS - 1)

struct s6e3fa2_ctx {
	struct drm_panel panel;
	struct mipi_dsi_device *dsi;
	struct regulator_bulk_data supplies[2];
	struct gpio_desc *reset_gpio;
	enum s6e3fa2_panel_subtype subtype;
	struct backlight_device *bl_dev;
	bool prepared;
	bool enabled;
};

static inline
struct s6e3fa2_ctx *panel_to_s6e3fa2(struct drm_panel *panel)
{
	return container_of(panel, struct s6e3fa2_ctx, panel);
}

#define dsi_generic_write_seq(dsi, seq...) do {				\
		static const u8 d[] = { seq };				\
		int ret;						\
		ret = mipi_dsi_generic_write(dsi, d, ARRAY_SIZE(d));	\
		if (ret < 0)						\
			return ret;					\
	} while (0)

#define dsi_generic_write_array(dsi, seq)				\
	ret = mipi_dsi_generic_write(dsi, seq, ARRAY_SIZE(seq));	\
	if (ret < 0)							\
		return ret;

#define dsi_dcs_write_seq(dsi, seq...) do {				\
		static const u8 d[] = { seq };				\
		int ret;						\
		ret = mipi_dsi_dcs_write_buffer(dsi, d, ARRAY_SIZE(d));	\
		if (ret < 0)						\
			return ret;					\
	} while (0)

static int s6e3fa2_dsi_dcs_read1(struct mipi_dsi_device *dsi, const u8 cmd, u8 *data)
{
	int ret;
	ret = mipi_dsi_dcs_read(dsi, cmd, data, 1);
	if (ret < 0) {
		dev_err(&dsi->dev, "could not read DCS CMD %02x\n", cmd);
		return ret;
	}
	return 0;
}

/* Manufacturer command set */
#define S6E3FA2_AID_CONTROL	0xb2  /* Samsung AMOLED impulsive driving */
#define S6E3FA2_ELVSS_CONTROL	0xb6  /* ELVSS - Amoled negative power supply */
#define S6E3FA2_GAMMA_CONTROL	0xca
/* Read ID commands */
#define S6E3FA2_READ_ID1	0xda
#define S6E3FA2_READ_ID2	0xdb
#define S6E3FA2_READ_ID3	0xdc

/* This is used in init sequence for both panels */
// static const u8 seq_max_brightness[] = {S6E3FA2_GAMMA_CONTROL,
// 	0x01, 0x00, 0x01, 0x00, 0x01, 0x00,
// 	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
// 	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
// 	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
// 	0x00, 0x00, 0x00
// };

#define NUM_AID_SEQUENCES	45
#define AID_SEQUENCE_LEN	4
/* Which AID sequence to use for each candela level.
 * This lookup table is same for both panels.
 */
static const u8 map_candela_to_aid[S6E3FA2_NUM_GAMMA_LEVELS] = {
	 0,  2,  3,  4,  6,  7,  8, 10, 11, 13, 14, 15,
	16, 17, 18, 20, 21, 22, 23, 24, 25, 26, 27, 28,
	29, 30, 31, 32, 33, 34, 35, 36, 36, 36, 36, 36,
	36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 37, 38,
	39, 40, 41, 42, 43, 44, 44, 44, 44, 44, 44, 44
};

/* AID (Amoled Impulsive Driving) tables */
static const u8 seq_s6e3fa2_aid[NUM_AID_SEQUENCES][AID_SEQUENCE_LEN] = {
	{0x07, 0x68, 0x00, 0x0E}, /* 0 */
	{0x07, 0x58, 0x00, 0x0E}, /* 1 */
	{0x07, 0x49, 0x00, 0x0E}, /* 2 */
	{0x07, 0x39, 0x00, 0x0E}, /* 3 */
	{0x07, 0x29, 0x00, 0x0E}, /* 4 */
	{0x07, 0x19, 0x00, 0x0E}, /* 5 */
	{0x07, 0x09, 0x00, 0x0E}, /* 6 */
	{0x06, 0xF8, 0x00, 0x0E}, /* 7 */
	{0x06, 0xE7, 0x00, 0x0E}, /* 8 */
	{0x06, 0xD7, 0x00, 0x0E}, /* 9 */
	{0x06, 0xC8, 0x00, 0x0E}, /* 10 */
	{0x06, 0xB7, 0x00, 0x0E}, /* 11 */
	{0x06, 0xA5, 0x00, 0x0E}, /* 12 */
	{0x06, 0x95, 0x00, 0x0E}, /* 13 */
	{0x06, 0x83, 0x00, 0x0E}, /* 14 */
	{0x06, 0x73, 0x00, 0x0E}, /* 15 */
	{0x06, 0x53, 0x00, 0x0E}, /* 16 */
	{0x06, 0x2F, 0x00, 0x0E}, /* 17 */
	{0x06, 0x27, 0x00, 0x0E}, /* 18 */
	{0x06, 0x17, 0x00, 0x0E}, /* 19 */
	{0x05, 0xFF, 0x00, 0x0E}, /* 20 */
	{0x05, 0xEF, 0x00, 0x0E}, /* 21 */
	{0x05, 0xCC, 0x00, 0x0E}, /* 22 */
	{0x05, 0xAB, 0x00, 0x0E}, /* 23 */
	{0x05, 0x98, 0x00, 0x0E}, /* 24 */
	{0x05, 0x76, 0x00, 0x0E}, /* 25 */
	{0x05, 0x53, 0x00, 0x0E}, /* 26 */
	{0x05, 0x1D, 0x00, 0x0E}, /* 27 */
	{0x04, 0xFB, 0x00, 0x0E}, /* 28 */
	{0x04, 0xD2, 0x00, 0x0E}, /* 29 */
	{0x04, 0x9E, 0x00, 0x0E}, /* 30 */
	{0x04, 0x62, 0x00, 0x0E}, /* 31 */
	{0x04, 0x2B, 0x00, 0x0E}, /* 32 */
	{0x03, 0xED, 0x00, 0x0E}, /* 33 */
	{0x03, 0xAD, 0x00, 0x0E}, /* 34 */
	{0x03, 0x56, 0x00, 0x0E}, /* 35 */
	{0x03, 0x29, 0x00, 0x0E}, /* 36 */
	{0x02, 0xBE, 0x00, 0x0E}, /* 37 */
	{0x02, 0x67, 0x00, 0x0E}, /* 38 */
	{0x02, 0x1D, 0x00, 0x0E}, /* 39 */
	{0x01, 0xBD, 0x00, 0x0E}, /* 40 */
	{0x01, 0x4E, 0x00, 0x0E}, /* 41 */
	{0x00, 0xD6, 0x00, 0x0E}, /* 42 */
	{0x00, 0x53, 0x00, 0x0E}, /* 43 */
	{0x00, 0x0E, 0x00, 0x0E}  /* 44 */
};

static const u8 seq_ea8064g_aid[NUM_AID_SEQUENCES][AID_SEQUENCE_LEN] = {
	{0x00, 0x0E, 0x07, 0x68}, /* 0 */
	{0x00, 0x0E, 0x07, 0x58}, /* 1 */
	{0x00, 0x0E, 0x07, 0x49}, /* 2 */
	{0x00, 0x0E, 0x07, 0x39}, /* 3 */
	{0x00, 0x0E, 0x07, 0x29}, /* 4 */
	{0x00, 0x0E, 0x07, 0x19}, /* 5 */
	{0x00, 0x0E, 0x07, 0x09}, /* 6 */
	{0x00, 0x0E, 0x06, 0xF8}, /* 7 */
	{0x00, 0x0E, 0x06, 0xE7}, /* 8 */
	{0x00, 0x0E, 0x06, 0xD7}, /* 9 */
	{0x00, 0x0E, 0x06, 0xC8}, /* 10 */
	{0x00, 0x0E, 0x06, 0xB7}, /* 11 */
	{0x00, 0x0E, 0x06, 0xA5}, /* 12 */
	{0x00, 0x0E, 0x06, 0x95}, /* 13 */
	{0x00, 0x0E, 0x06, 0x83}, /* 14 */
	{0x00, 0x0E, 0x06, 0x73}, /* 15 */
	{0x00, 0x0E, 0x06, 0x53}, /* 16 */
	{0x00, 0x0E, 0x06, 0x2F}, /* 17 */
	{0x00, 0x0E, 0x06, 0x27}, /* 18 */
	{0x00, 0x0E, 0x06, 0x17}, /* 19 */
	{0x00, 0x0E, 0x05, 0xFF}, /* 20 */
	{0x00, 0x0E, 0x05, 0xEF}, /* 21 */
	{0x00, 0x0E, 0x05, 0xCC}, /* 22 */
	{0x00, 0x0E, 0x05, 0xAB}, /* 23 */
	{0x00, 0x0E, 0x05, 0x98}, /* 24 */
	{0x00, 0x0E, 0x05, 0x76}, /* 25 */
	{0x00, 0x0E, 0x05, 0x53}, /* 26 */
	{0x00, 0x0E, 0x05, 0x1D}, /* 27 */
	{0x00, 0x0E, 0x04, 0xFB}, /* 28 */
	{0x00, 0x0E, 0x04, 0xD2}, /* 29 */
	{0x00, 0x0E, 0x04, 0x9E}, /* 30 */
	{0x00, 0x0E, 0x04, 0x62}, /* 31 */
	{0x00, 0x0E, 0x04, 0x2B}, /* 32 */
	{0x00, 0x0E, 0x03, 0xED}, /* 33 */
	{0x00, 0x0E, 0x03, 0xAD}, /* 34 */
	{0x00, 0x0E, 0x03, 0x56}, /* 35 */
	{0x00, 0x0E, 0x03, 0x29}, /* 36 */
	{0x00, 0x0E, 0x02, 0xBE}, /* 37 */
	{0x00, 0x0E, 0x02, 0x67}, /* 38 */
	{0x00, 0x0E, 0x02, 0x1D}, /* 39 */
	{0x00, 0x0E, 0x01, 0xBD}, /* 40 */
	{0x00, 0x0E, 0x01, 0x4E}, /* 41 */
	{0x00, 0x0E, 0x00, 0xD6}, /* 42 */
	{0x00, 0x0E, 0x00, 0x53}, /* 43 */
	{0x00, 0x0E, 0x00, 0x0E}  /* 44 */
};

/* Which ELVSS sequence to use for which candela level.
 * This lookup table is the same for both panels.
 */
static const u8 map_candela_to_elvss[S6E3FA2_NUM_GAMMA_LEVELS] = {
	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
	1, 2, 3, 4, 5, 6,
	7, 7, 7, 7, 7,
	8, 8, 8,
	9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20,
	21, 22, 23, 24, 25, 26, 27, 28, 29, 30
};

/* ELVSS (Amoled negative power supply) tables */
#define NUM_ELVSS_SEQUENCES	31
#define ELVSS_SEQUENCE_LEN	2
static const u8 seq_s6e3fa2_elvss[NUM_ELVSS_SEQUENCES][ELVSS_SEQUENCE_LEN] = {
	{0x98, 0x0B},
	{0x98, 0x0C},
	{0x98, 0x0C},
	{0x98, 0x0D},
	{0x98, 0x0D},
	{0x98, 0x0E},
	{0x98, 0x0F},
	{0x98, 0x10},
	{0x98, 0x0F},
	{0x98, 0x0E},
	{0x98, 0x0E},
	{0x98, 0x0D},
	{0x98, 0x0D},
	{0x98, 0x0C},
	{0x98, 0x0C},
	{0x98, 0x0B},
	{0x98, 0x0A},
	{0x98, 0x09},
	{0x98, 0x09},
	{0x98, 0x09},
	{0x98, 0x09},
	{0x98, 0x09},
	{0x98, 0x09},
	{0x98, 0x09},
	{0x98, 0x09},
	{0x98, 0x08},
	{0x98, 0x07},
	{0x98, 0x06},
	{0x98, 0x06},
	{0x98, 0x05},
	{0x98, 0x04}
};
static const u8 seq_ea8064g_elvss[NUM_ELVSS_SEQUENCES][ELVSS_SEQUENCE_LEN] = {
	{0x48, 0x8B},
	{0x48, 0x8C},
	{0x48, 0x8C},
	{0x48, 0x8D},
	{0x48, 0x8D},
	{0x48, 0x8E},
	{0x48, 0x8F},
	{0x48, 0x90},
	{0x48, 0x8F},
	{0x48, 0x8E},
	{0x48, 0x8E},
	{0x48, 0x8D},
	{0x48, 0x8D},
	{0x48, 0x8C},
	{0x48, 0x8C},
	{0x48, 0x8B},
	{0x48, 0x8A},
	{0x48, 0x89},
	{0x48, 0x89},
	{0x48, 0x89},
	{0x48, 0x89},
	{0x48, 0x89},
	{0x48, 0x89},
	{0x48, 0x89},
	{0x48, 0x89},
	{0x48, 0x88},
	{0x48, 0x87},
	{0x48, 0x86},
	{0x48, 0x86},
	{0x48, 0x85},
	{0x48, 0x84}
};

/* Gamma (lux) tables */
#define GAMMA_SEQUENCE_LEN	33
static const u8 seq_s6e3fa2_lux[S6E3FA2_NUM_GAMMA_LEVELS][GAMMA_SEQUENCE_LEN] = {
	{0x00, 0xB7, 0x00, 0xC6, 0x00, 0xAB, 0x8B, 0x90, 0x8C, 0x8C, 0x91, 0x8A, 0x8E, 0x99, 0x91, 0x92, 0x9D, 0x8E, 0x93, 0x96, 0x8F, 0x91, 0x92, 0x8D, 0xAD, 0xA2, 0x9B, 0x9B, 0x93, 0xAC, 0x00, 0x00, 0x00},
	{0x00, 0xBB, 0x00, 0xC6, 0x00, 0xB0, 0x8A, 0x8D, 0x8A, 0x8B, 0x8F, 0x8B, 0x8C, 0x94, 0x8C, 0x8D, 0x98, 0x8E, 0x8E, 0x93, 0x8C, 0x8F, 0x93, 0x8A, 0xAA, 0xA2, 0x97, 0x9C, 0x94, 0xAD, 0x00, 0x00, 0x00},
	{0x00, 0xBC, 0x00, 0xC6, 0x00, 0xB1, 0x8A, 0x8D, 0x8B, 0x8A, 0x8E, 0x89, 0x8B, 0x93, 0x8C, 0x8E, 0x97, 0x8E, 0x8C, 0x92, 0x8D, 0x8E, 0x91, 0x87, 0xA8, 0xA1, 0x94, 0x9E, 0x96, 0xAF, 0x00, 0x00, 0x00},
	{0x00, 0xBC, 0x00, 0xC6, 0x00, 0xB2, 0x8B, 0x8C, 0x8A, 0x8A, 0x8D, 0x89, 0x8C, 0x92, 0x8C, 0x8C, 0x95, 0x8D, 0x8B, 0x91, 0x8A, 0x8E, 0x91, 0x88, 0xA6, 0xA1, 0x92, 0x9C, 0x94, 0xAD, 0x00, 0x00, 0x00},
	{0x00, 0xBD, 0x00, 0xC6, 0x00, 0xB3, 0x8B, 0x8C, 0x8A, 0x89, 0x8C, 0x89, 0x8A, 0x8F, 0x89, 0x8B, 0x93, 0x8B, 0x8B, 0x90, 0x8A, 0x8B, 0x91, 0x89, 0xA6, 0xA0, 0x8E, 0x9D, 0x95, 0xAE, 0x00, 0x00, 0x00},
	{0x00, 0xBD, 0x00, 0xC6, 0x00, 0xB3, 0x8A, 0x8C, 0x8B, 0x89, 0x8B, 0x87, 0x8A, 0x8F, 0x8A, 0x8B, 0x92, 0x8C, 0x8B, 0x90, 0x8A, 0x8A, 0x90, 0x88, 0xA5, 0xA0, 0x8E, 0x98, 0x91, 0xAA, 0x00, 0x00, 0x00},
	{0x00, 0xBD, 0x00, 0xC6, 0x00, 0xB3, 0x8A, 0x8C, 0x8A, 0x89, 0x8C, 0x88, 0x8A, 0x8F, 0x8A, 0x89, 0x91, 0x8A, 0x8B, 0x90, 0x8A, 0x8B, 0x90, 0x89, 0xA5, 0x9F, 0x8D, 0x98, 0x91, 0xAA, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x8A, 0x8C, 0x8A, 0x89, 0x8B, 0x88, 0x8A, 0x8C, 0x89, 0x89, 0x91, 0x8A, 0x89, 0x8E, 0x89, 0x8B, 0x8F, 0x88, 0xA2, 0x9D, 0x88, 0x9F, 0x97, 0xB0, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x89, 0x8B, 0x89, 0x8A, 0x8B, 0x89, 0x88, 0x8C, 0x8A, 0x89, 0x90, 0x89, 0x88, 0x8E, 0x88, 0x8A, 0x8F, 0x88, 0xA4, 0x9E, 0x8A, 0x98, 0x91, 0xA9, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x8A, 0x8B, 0x8A, 0x89, 0x8A, 0x88, 0x89, 0x8C, 0x89, 0x8A, 0x90, 0x8A, 0x85, 0x8C, 0x86, 0x89, 0x8D, 0x85, 0xA3, 0x9F, 0x8B, 0x9D, 0x95, 0xAE, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x89, 0x8B, 0x8A, 0x8A, 0x8A, 0x88, 0x89, 0x8C, 0x89, 0x87, 0x8E, 0x88, 0x87, 0x8D, 0x88, 0x8B, 0x8E, 0x88, 0xA0, 0x9D, 0x86, 0x97, 0x91, 0xAB, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x89, 0x8A, 0x89, 0x89, 0x8A, 0x87, 0x89, 0x8B, 0x8A, 0x87, 0x8E, 0x87, 0x87, 0x8D, 0x88, 0x88, 0x8E, 0x87, 0xA0, 0x9C, 0x86, 0x9A, 0x93, 0xAD, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x89, 0x8A, 0x89, 0x89, 0x8A, 0x87, 0x89, 0x8A, 0x8B, 0x87, 0x8D, 0x86, 0x87, 0x8C, 0x87, 0x88, 0x8D, 0x85, 0xA2, 0x9E, 0x8A, 0x9A, 0x93, 0xAD, 0x00, 0x00, 0x00},
	{0x00, 0xBD, 0x00, 0xC6, 0x00, 0xB3, 0x8A, 0x8A, 0x89, 0x88, 0x89, 0x87, 0x88, 0x8A, 0x88, 0x86, 0x8D, 0x88, 0x86, 0x8B, 0x86, 0x8B, 0x8E, 0x88, 0x9F, 0x9D, 0x86, 0x96, 0x91, 0xAA, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x89, 0x8A, 0x89, 0x89, 0x8A, 0x88, 0x88, 0x89, 0x87, 0x87, 0x8D, 0x88, 0x87, 0x8C, 0x88, 0x8A, 0x8E, 0x87, 0x9D, 0x9B, 0x85, 0x99, 0x93, 0xAD, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x89, 0x8A, 0x89, 0x8A, 0x8A, 0x88, 0x88, 0x89, 0x88, 0x87, 0x8D, 0x88, 0x84, 0x89, 0x85, 0x89, 0x8D, 0x86, 0x9E, 0x9C, 0x87, 0x99, 0x93, 0xAD, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x89, 0x8A, 0x89, 0x89, 0x89, 0x87, 0x88, 0x89, 0x88, 0x86, 0x8C, 0x86, 0x87, 0x8B, 0x88, 0x89, 0x8D, 0x86, 0x9C, 0x9B, 0x85, 0x95, 0x90, 0xAA, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x8A, 0x8A, 0x89, 0x88, 0x89, 0x87, 0x88, 0x89, 0x88, 0x87, 0x8C, 0x87, 0x87, 0x8B, 0x88, 0x87, 0x8A, 0x83, 0x9C, 0x9A, 0x86, 0x91, 0x8E, 0xA7, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x89, 0x8A, 0x89, 0x89, 0x89, 0x87, 0x88, 0x89, 0x89, 0x84, 0x8B, 0x84, 0x87, 0x8A, 0x87, 0x88, 0x8A, 0x84, 0x9C, 0x9A, 0x87, 0x91, 0x8E, 0xA7, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x89, 0x8A, 0x89, 0x89, 0x89, 0x87, 0x88, 0x89, 0x89, 0x85, 0x8B, 0x85, 0x87, 0x8A, 0x87, 0x87, 0x8A, 0x84, 0x9B, 0x99, 0x85, 0x8D, 0x8B, 0xA4, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x89, 0x8A, 0x89, 0x89, 0x89, 0x87, 0x89, 0x89, 0x89, 0x83, 0x89, 0x84, 0x87, 0x8A, 0x86, 0x88, 0x8A, 0x85, 0x9B, 0x99, 0x85, 0x95, 0x90, 0xAA, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x89, 0x8A, 0x89, 0x88, 0x89, 0x86, 0x88, 0x88, 0x8A, 0x85, 0x8A, 0x86, 0x85, 0x88, 0x85, 0x86, 0x89, 0x83, 0x9C, 0x9A, 0x86, 0x91, 0x8D, 0xA7, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x88, 0x89, 0x89, 0x88, 0x89, 0x87, 0x88, 0x88, 0x8A, 0x84, 0x89, 0x84, 0x87, 0x8A, 0x88, 0x87, 0x89, 0x84, 0x96, 0x98, 0x82, 0x95, 0x90, 0xAA, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x88, 0x89, 0x89, 0x88, 0x89, 0x88, 0x88, 0x87, 0x88, 0x85, 0x8A, 0x85, 0x84, 0x87, 0x83, 0x89, 0x8C, 0x87, 0x96, 0x97, 0x81, 0x99, 0x93, 0xAD, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x88, 0x89, 0x89, 0x88, 0x89, 0x87, 0x88, 0x87, 0x89, 0x85, 0x8A, 0x85, 0x84, 0x87, 0x83, 0x8A, 0x8C, 0x88, 0x96, 0x97, 0x82, 0x95, 0x90, 0xAA, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x88, 0x89, 0x89, 0x88, 0x89, 0x88, 0x89, 0x88, 0x8A, 0x84, 0x89, 0x84, 0x85, 0x88, 0x85, 0x85, 0x88, 0x84, 0x98, 0x97, 0x83, 0x90, 0x8D, 0xA6, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x88, 0x89, 0x89, 0x88, 0x89, 0x88, 0x88, 0x86, 0x87, 0x83, 0x89, 0x84, 0x87, 0x89, 0x86, 0x85, 0x88, 0x85, 0x98, 0x98, 0x85, 0x88, 0x87, 0x9E, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x88, 0x89, 0x89, 0x89, 0x89, 0x88, 0x87, 0x86, 0x87, 0x84, 0x89, 0x85, 0x85, 0x87, 0x84, 0x84, 0x88, 0x83, 0x99, 0x98, 0x84, 0x94, 0x90, 0xA9, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x88, 0x89, 0x89, 0x89, 0x89, 0x88, 0x88, 0x87, 0x88, 0x81, 0x86, 0x83, 0x88, 0x89, 0x86, 0x85, 0x88, 0x84, 0x95, 0x95, 0x81, 0x99, 0x93, 0xAC, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x88, 0x89, 0x89, 0x88, 0x89, 0x87, 0x88, 0x86, 0x88, 0x84, 0x89, 0x85, 0x86, 0x87, 0x84, 0x84, 0x88, 0x84, 0x9A, 0x98, 0x86, 0x8C, 0x8A, 0xA0, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC6, 0x00, 0xB4, 0x88, 0x89, 0x89, 0x88, 0x89, 0x87, 0x88, 0x86, 0x88, 0x83, 0x88, 0x84, 0x88, 0x89, 0x86, 0x81, 0x84, 0x81, 0x98, 0x96, 0x83, 0x99, 0x93, 0xAC, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC7, 0x00, 0xB5, 0x89, 0x89, 0x89, 0x89, 0x89, 0x87, 0x88, 0x88, 0x88, 0x83, 0x87, 0x85, 0x87, 0x87, 0x84, 0x85, 0x88, 0x85, 0x96, 0x95, 0x83, 0x8C, 0x8A, 0x9D, 0x00, 0x00, 0x00},
	{0x00, 0xC2, 0x00, 0xC9, 0x00, 0xB8, 0x88, 0x89, 0x89, 0x88, 0x89, 0x87, 0x88, 0x86, 0x87, 0x84, 0x88, 0x85, 0x84, 0x85, 0x82, 0x85, 0x88, 0x85, 0x95, 0x94, 0x83, 0x8C, 0x8A, 0x9D, 0x00, 0x00, 0x00},
	{0x00, 0xC4, 0x00, 0xCB, 0x00, 0xBA, 0x89, 0x89, 0x89, 0x87, 0x87, 0x85, 0x87, 0x87, 0x88, 0x83, 0x86, 0x84, 0x85, 0x87, 0x84, 0x82, 0x85, 0x83, 0x95, 0x94, 0x82, 0x8C, 0x8A, 0x9D, 0x00, 0x00, 0x00},
	{0x00, 0xC7, 0x00, 0xCE, 0x00, 0xBE, 0x87, 0x88, 0x88, 0x88, 0x88, 0x87, 0x87, 0x86, 0x86, 0x82, 0x86, 0x83, 0x84, 0x86, 0x83, 0x83, 0x85, 0x83, 0x94, 0x94, 0x83, 0x8C, 0x8A, 0x9D, 0x00, 0x00, 0x00},
	{0x00, 0xCA, 0x00, 0xD0, 0x00, 0xC1, 0x88, 0x88, 0x88, 0x87, 0x88, 0x86, 0x86, 0x86, 0x86, 0x83, 0x85, 0x83, 0x84, 0x86, 0x84, 0x84, 0x86, 0x82, 0x96, 0x95, 0x85, 0x94, 0x90, 0xA9, 0x00, 0x00, 0x00},
	{0x00, 0xCD, 0x00, 0xD2, 0x00, 0xC5, 0x87, 0x88, 0x88, 0x87, 0x87, 0x85, 0x86, 0x86, 0x87, 0x82, 0x86, 0x84, 0x86, 0x87, 0x86, 0x81, 0x84, 0x7F, 0x93, 0x92, 0x83, 0x84, 0x84, 0x91, 0x00, 0x00, 0x00},
	{0x00, 0xD0, 0x00, 0xD5, 0x00, 0xC8, 0x86, 0x87, 0x87, 0x87, 0x87, 0x86, 0x85, 0x84, 0x85, 0x84, 0x86, 0x84, 0x84, 0x85, 0x83, 0x82, 0x85, 0x81, 0x93, 0x92, 0x85, 0x7C, 0x7E, 0x84, 0x00, 0x00, 0x00},
	{0x00, 0xD2, 0x00, 0xD7, 0x00, 0xCB, 0x86, 0x87, 0x87, 0x87, 0x88, 0x86, 0x85, 0x85, 0x86, 0x85, 0x86, 0x85, 0x81, 0x84, 0x81, 0x83, 0x85, 0x81, 0x93, 0x92, 0x83, 0x84, 0x84, 0x94, 0x00, 0x00, 0x00},
	{0x00, 0xD6, 0x00, 0xDA, 0x00, 0xCF, 0x86, 0x87, 0x87, 0x85, 0x86, 0x84, 0x86, 0x85, 0x86, 0x84, 0x85, 0x83, 0x81, 0x84, 0x81, 0x83, 0x85, 0x82, 0x92, 0x91, 0x83, 0x80, 0x81, 0x8E, 0x00, 0x00, 0x00},
	{0x00, 0xD9, 0x00, 0xDD, 0x00, 0xD2, 0x85, 0x86, 0x87, 0x86, 0x86, 0x85, 0x85, 0x84, 0x85, 0x83, 0x84, 0x85, 0x81, 0x82, 0x81, 0x85, 0x86, 0x83, 0x8E, 0x8E, 0x82, 0x7C, 0x7E, 0x84, 0x00, 0x00, 0x00},
	{0x00, 0xDD, 0x00, 0xE0, 0x00, 0xD7, 0x85, 0x86, 0x85, 0x85, 0x85, 0x84, 0x84, 0x84, 0x84, 0x84, 0x85, 0x84, 0x83, 0x85, 0x84, 0x83, 0x84, 0x7F, 0x8C, 0x8C, 0x7F, 0x88, 0x87, 0x97, 0x00, 0x00, 0x00},
	{0x00, 0xDF, 0x00, 0xE3, 0x00, 0xD9, 0x85, 0x85, 0x86, 0x85, 0x85, 0x84, 0x84, 0x84, 0x85, 0x84, 0x83, 0x83, 0x83, 0x83, 0x83, 0x83, 0x84, 0x80, 0x8A, 0x8B, 0x7E, 0x84, 0x84, 0x91, 0x00, 0x00, 0x00},
	{0x00, 0xE2, 0x00, 0xE5, 0x00, 0xDE, 0x85, 0x85, 0x85, 0x85, 0x85, 0x83, 0x82, 0x83, 0x84, 0x83, 0x84, 0x83, 0x81, 0x84, 0x83, 0x81, 0x82, 0x7D, 0x8F, 0x8E, 0x83, 0x78, 0x7B, 0x82, 0x00, 0x00, 0x00},
	{0x00, 0xE5, 0x00, 0xE8, 0x00, 0xE0, 0x84, 0x85, 0x85, 0x84, 0x84, 0x83, 0x84, 0x84, 0x84, 0x84, 0x83, 0x83, 0x80, 0x82, 0x81, 0x82, 0x84, 0x80, 0x8C, 0x8B, 0x80, 0x7C, 0x7E, 0x88, 0x00, 0x00, 0x00},
	{0x00, 0xE7, 0x00, 0xEB, 0x00, 0xE5, 0x85, 0x84, 0x85, 0x83, 0x84, 0x84, 0x82, 0x83, 0x83, 0x82, 0x83, 0x83, 0x81, 0x83, 0x82, 0x80, 0x82, 0x7D, 0x8C, 0x8B, 0x81, 0x78, 0x7B, 0x82, 0x00, 0x00, 0x00},
	{0x00, 0xE7, 0x00, 0xEA, 0x00, 0xE3, 0x85, 0x85, 0x85, 0x84, 0x84, 0x84, 0x82, 0x82, 0x83, 0x84, 0x83, 0x84, 0x80, 0x82, 0x81, 0x83, 0x84, 0x80, 0x86, 0x87, 0x7B, 0x80, 0x80, 0x87, 0x00, 0x00, 0x00},
	{0x00, 0xE7, 0x00, 0xEA, 0x00, 0xE3, 0x85, 0x85, 0x85, 0x84, 0x84, 0x84, 0x82, 0x82, 0x83, 0x81, 0x82, 0x82, 0x80, 0x82, 0x80, 0x84, 0x84, 0x80, 0x89, 0x88, 0x7E, 0x78, 0x7A, 0x7A, 0x00, 0x00, 0x00},
	{0x00, 0xE8, 0x00, 0xEB, 0x00, 0xE4, 0x84, 0x84, 0x84, 0x84, 0x84, 0x83, 0x83, 0x83, 0x84, 0x83, 0x82, 0x83, 0x81, 0x82, 0x82, 0x82, 0x82, 0x7E, 0x87, 0x87, 0x7C, 0x88, 0x86, 0x93, 0x00, 0x00, 0x00},
	{0x00, 0xE7, 0x00, 0xEB, 0x00, 0xE4, 0x84, 0x84, 0x85, 0x85, 0x84, 0x82, 0x82, 0x82, 0x83, 0x82, 0x82, 0x82, 0x80, 0x82, 0x81, 0x84, 0x84, 0x80, 0x87, 0x86, 0x7D, 0x78, 0x7A, 0x7A, 0x00, 0x00, 0x00},
	{0x00, 0xE7, 0x00, 0xEB, 0x00, 0xE4, 0x84, 0x84, 0x84, 0x83, 0x84, 0x83, 0x82, 0x83, 0x83, 0x82, 0x82, 0x82, 0x80, 0x82, 0x81, 0x81, 0x81, 0x7D, 0x8A, 0x89, 0x82, 0x78, 0x7A, 0x7A, 0x00, 0x00, 0x00},
	{0x00, 0xE7, 0x00, 0xEB, 0x00, 0xE4, 0x84, 0x84, 0x84, 0x83, 0x83, 0x83, 0x82, 0x82, 0x82, 0x82, 0x81, 0x83, 0x82, 0x83, 0x81, 0x82, 0x81, 0x7E, 0x87, 0x86, 0x7F, 0x7B, 0x7D, 0x7D, 0x00, 0x00, 0x00},
	{0x00, 0xE7, 0x00, 0xEB, 0x00, 0xE4, 0x84, 0x84, 0x84, 0x83, 0x83, 0x83, 0x81, 0x81, 0x81, 0x84, 0x82, 0x84, 0x80, 0x81, 0x81, 0x83, 0x83, 0x7F, 0x88, 0x86, 0x80, 0x7B, 0x7D, 0x7D, 0x00, 0x00, 0x00},
	{0x00, 0xEA, 0x00, 0xED, 0x00, 0xE6, 0x83, 0x83, 0x83, 0x84, 0x83, 0x83, 0x82, 0x82, 0x82, 0x81, 0x82, 0x81, 0x7F, 0x7F, 0x80, 0x83, 0x83, 0x83, 0x88, 0x86, 0x86, 0x7B, 0x7D, 0x7D, 0x00, 0x00, 0x00},
	{0x00, 0xED, 0x00, 0xEF, 0x00, 0xEA, 0x83, 0x83, 0x83, 0x83, 0x83, 0x83, 0x81, 0x81, 0x81, 0x82, 0x82, 0x82, 0x80, 0x80, 0x81, 0x80, 0x81, 0x81, 0x88, 0x86, 0x86, 0x7B, 0x7D, 0x7D, 0x00, 0x00, 0x00},
	{0x00, 0xF1, 0x00, 0xF3, 0x00, 0xEE, 0x82, 0x82, 0x82, 0x83, 0x83, 0x83, 0x81, 0x81, 0x81, 0x81, 0x82, 0x81, 0x81, 0x81, 0x81, 0x82, 0x82, 0x82, 0x84, 0x83, 0x83, 0x7B, 0x7D, 0x7D, 0x00, 0x00, 0x00},
	{0x00, 0xF5, 0x00, 0xF6, 0x00, 0xF3, 0x81, 0x82, 0x82, 0x82, 0x82, 0x82, 0x80, 0x80, 0x80, 0x80, 0x81, 0x80, 0x81, 0x81, 0x81, 0x82, 0x82, 0x82, 0x84, 0x83, 0x83, 0x7B, 0x7D, 0x7D, 0x00, 0x00, 0x00},
	{0x00, 0xF9, 0x00, 0xFA, 0x00, 0xF8, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x82, 0x7F, 0x7F, 0x7F, 0x81, 0x81, 0x81, 0x80, 0x80, 0x80, 0x82, 0x81, 0x80, 0x80, 0x80, 0x83, 0x00, 0x00, 0x00},
	{0x00, 0xFC, 0x00, 0xFD, 0x00, 0xFC, 0x80, 0x80, 0x80, 0x81, 0x81, 0x81, 0x81, 0x81, 0x81, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x82, 0x81, 0x80, 0x7B, 0x7D, 0x7D, 0x00, 0x00, 0x00},
	{0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00}
};

static const u8 seq_ea8064g_lux[S6E3FA2_NUM_GAMMA_LEVELS][GAMMA_SEQUENCE_LEN] = {
	{0x00, 0xB8, 0x00, 0xC5, 0x00, 0xA9, 0x8B, 0x91, 0x8D, 0x8A, 0x90, 0x8A, 0x8E, 0x99, 0x91, 0x92, 0x9D, 0x8F, 0x92, 0x95, 0x8E, 0x93, 0x92, 0x8C, 0xAE, 0xA5, 0x9C, 0x9B, 0x93, 0xAC, 0x00, 0x00, 0x00},
	{0x00, 0xBC, 0x00, 0xC5, 0x00, 0xAE, 0x8A, 0x8E, 0x8B, 0x89, 0x8E, 0x8B, 0x8C, 0x94, 0x8C, 0x8D, 0x98, 0x8E, 0x8D, 0x92, 0x8B, 0x91, 0x93, 0x89, 0xAB, 0xA5, 0x99, 0x9C, 0x94, 0xAD, 0x00, 0x00, 0x00},
	{0x00, 0xBD, 0x00, 0xC5, 0x00, 0xAF, 0x8A, 0x8E, 0x8C, 0x88, 0x8D, 0x89, 0x8B, 0x93, 0x8B, 0x8E, 0x97, 0x8E, 0x8B, 0x91, 0x8B, 0x90, 0x91, 0x86, 0xA9, 0xA4, 0x96, 0x9E, 0x96, 0xAF, 0x00, 0x00, 0x00},
	{0x00, 0xBD, 0x00, 0xC5, 0x00, 0xB0, 0x8B, 0x8D, 0x8B, 0x88, 0x8C, 0x89, 0x8C, 0x92, 0x8C, 0x8C, 0x96, 0x8D, 0x8A, 0x91, 0x89, 0x90, 0x91, 0x88, 0xA8, 0xA4, 0x93, 0x9C, 0x94, 0xAD, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC5, 0x00, 0xB1, 0x8B, 0x8D, 0x8B, 0x87, 0x8B, 0x89, 0x8A, 0x8F, 0x89, 0x8B, 0x93, 0x8C, 0x8A, 0x90, 0x89, 0x8E, 0x91, 0x88, 0xA7, 0xA3, 0x8F, 0x9D, 0x95, 0xAE, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC5, 0x00, 0xB1, 0x8A, 0x8D, 0x8C, 0x87, 0x8A, 0x87, 0x8A, 0x8E, 0x89, 0x8B, 0x93, 0x8C, 0x8A, 0x90, 0x8A, 0x8D, 0x90, 0x87, 0xA6, 0xA3, 0x90, 0x98, 0x91, 0xAA, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC5, 0x00, 0xB1, 0x8A, 0x8C, 0x8B, 0x87, 0x8B, 0x88, 0x8A, 0x8E, 0x89, 0x89, 0x91, 0x8A, 0x8A, 0x90, 0x8A, 0x8E, 0x90, 0x88, 0xA5, 0xA2, 0x8E, 0x98, 0x91, 0xAA, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x8A, 0x8C, 0x8B, 0x87, 0x8A, 0x88, 0x8A, 0x8C, 0x88, 0x89, 0x91, 0x8B, 0x88, 0x8E, 0x89, 0x8D, 0x8F, 0x88, 0xA3, 0xA0, 0x8A, 0x9F, 0x97, 0xB0, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x89, 0x8C, 0x8A, 0x88, 0x8A, 0x89, 0x88, 0x8B, 0x89, 0x8A, 0x91, 0x8A, 0x87, 0x8E, 0x88, 0x8C, 0x8F, 0x88, 0xA5, 0xA1, 0x8C, 0x97, 0x91, 0xAA, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x8A, 0x8C, 0x8B, 0x87, 0x89, 0x88, 0x89, 0x8B, 0x88, 0x8A, 0x91, 0x8B, 0x85, 0x8C, 0x85, 0x8A, 0x8D, 0x85, 0xA3, 0xA2, 0x8C, 0x9C, 0x95, 0xAE, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x89, 0x8C, 0x8B, 0x88, 0x89, 0x88, 0x89, 0x8B, 0x88, 0x87, 0x8F, 0x89, 0x87, 0x8D, 0x87, 0x8C, 0x8E, 0x88, 0xA0, 0xA0, 0x88, 0x97, 0x91, 0xAB, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x89, 0x8B, 0x8A, 0x87, 0x89, 0x87, 0x89, 0x8B, 0x89, 0x88, 0x8E, 0x88, 0x87, 0x8D, 0x87, 0x89, 0x8E, 0x86, 0xA0, 0x9F, 0x88, 0x99, 0x93, 0xAD, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x89, 0x8B, 0x8A, 0x87, 0x89, 0x87, 0x89, 0x89, 0x8A, 0x87, 0x8E, 0x88, 0x86, 0x8C, 0x87, 0x89, 0x8D, 0x84, 0xA2, 0xA1, 0x8B, 0x99, 0x93, 0xAD, 0x00, 0x00, 0x00},
	{0x00, 0xBE, 0x00, 0xC5, 0x00, 0xB1, 0x8A, 0x8B, 0x8A, 0x86, 0x88, 0x87, 0x88, 0x89, 0x87, 0x86, 0x8E, 0x89, 0x85, 0x8B, 0x86, 0x8C, 0x8E, 0x87, 0x9F, 0xA0, 0x87, 0x95, 0x90, 0xAA, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x89, 0x8B, 0x8A, 0x87, 0x89, 0x88, 0x88, 0x88, 0x87, 0x87, 0x8E, 0x89, 0x86, 0x8C, 0x88, 0x8B, 0x8E, 0x86, 0x9D, 0x9D, 0x86, 0x99, 0x93, 0xAD, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x89, 0x8B, 0x8A, 0x88, 0x89, 0x88, 0x88, 0x88, 0x88, 0x87, 0x8E, 0x89, 0x83, 0x89, 0x84, 0x8A, 0x8D, 0x85, 0x9F, 0x9E, 0x88, 0x99, 0x93, 0xAD, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x89, 0x8B, 0x8A, 0x87, 0x88, 0x87, 0x88, 0x88, 0x87, 0x87, 0x8D, 0x87, 0x85, 0x8B, 0x87, 0x8A, 0x8D, 0x85, 0x9D, 0x9D, 0x86, 0x95, 0x90, 0xAA, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x8A, 0x8B, 0x8A, 0x86, 0x88, 0x87, 0x88, 0x88, 0x87, 0x88, 0x8D, 0x88, 0x85, 0x8B, 0x87, 0x88, 0x8A, 0x83, 0x9C, 0x9C, 0x87, 0x91, 0x8D, 0xA7, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x89, 0x8B, 0x8A, 0x87, 0x88, 0x87, 0x88, 0x88, 0x88, 0x85, 0x8C, 0x86, 0x86, 0x8A, 0x87, 0x89, 0x8A, 0x84, 0x9C, 0x9C, 0x88, 0x91, 0x8D, 0xA7, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x89, 0x8B, 0x8A, 0x87, 0x88, 0x87, 0x88, 0x88, 0x88, 0x86, 0x8C, 0x87, 0x86, 0x8A, 0x87, 0x88, 0x8A, 0x84, 0x9B, 0x9B, 0x86, 0x8C, 0x8A, 0xA4, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x89, 0x8B, 0x8A, 0x87, 0x88, 0x87, 0x89, 0x88, 0x88, 0x84, 0x8A, 0x86, 0x85, 0x8A, 0x86, 0x88, 0x8A, 0x85, 0x9C, 0x9B, 0x85, 0x95, 0x90, 0xA9, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x89, 0x8B, 0x8A, 0x86, 0x88, 0x86, 0x88, 0x87, 0x89, 0x85, 0x8B, 0x88, 0x83, 0x88, 0x84, 0x87, 0x89, 0x83, 0x9C, 0x9C, 0x86, 0x90, 0x8C, 0xA6, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x88, 0x8A, 0x8A, 0x86, 0x88, 0x87, 0x88, 0x87, 0x89, 0x85, 0x89, 0x86, 0x85, 0x8A, 0x87, 0x88, 0x89, 0x84, 0x97, 0x99, 0x83, 0x94, 0x8F, 0xA9, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x88, 0x8A, 0x8A, 0x86, 0x88, 0x88, 0x88, 0x86, 0x87, 0x86, 0x8B, 0x86, 0x82, 0x87, 0x83, 0x89, 0x8B, 0x86, 0x97, 0x98, 0x82, 0x99, 0x92, 0xAC, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x88, 0x8A, 0x8A, 0x86, 0x88, 0x87, 0x88, 0x86, 0x88, 0x86, 0x8B, 0x86, 0x82, 0x87, 0x83, 0x8A, 0x8B, 0x87, 0x97, 0x98, 0x83, 0x94, 0x8F, 0xA9, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x88, 0x8A, 0x8A, 0x86, 0x88, 0x88, 0x89, 0x87, 0x89, 0x85, 0x89, 0x86, 0x83, 0x88, 0x85, 0x86, 0x88, 0x83, 0x98, 0x98, 0x84, 0x90, 0x8C, 0xA6, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x88, 0x8A, 0x8A, 0x86, 0x88, 0x88, 0x88, 0x85, 0x86, 0x84, 0x8A, 0x86, 0x85, 0x89, 0x86, 0x86, 0x88, 0x84, 0x99, 0x9A, 0x86, 0x88, 0x86, 0x9D, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x88, 0x8A, 0x8A, 0x87, 0x88, 0x88, 0x87, 0x85, 0x86, 0x85, 0x8A, 0x87, 0x83, 0x87, 0x84, 0x85, 0x87, 0x82, 0x9A, 0x99, 0x85, 0x94, 0x8F, 0xA9, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x88, 0x8A, 0x8A, 0x87, 0x88, 0x88, 0x88, 0x86, 0x87, 0x82, 0x87, 0x85, 0x86, 0x88, 0x86, 0x86, 0x87, 0x83, 0x96, 0x97, 0x81, 0x98, 0x92, 0xAC, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x88, 0x8A, 0x8A, 0x86, 0x88, 0x87, 0x88, 0x85, 0x87, 0x85, 0x8A, 0x87, 0x84, 0x87, 0x84, 0x85, 0x87, 0x83, 0x9B, 0x99, 0x87, 0x8C, 0x89, 0xA0, 0x00, 0x00, 0x00},
	{0x00, 0xBF, 0x00, 0xC5, 0x00, 0xB2, 0x88, 0x8A, 0x8A, 0x86, 0x88, 0x87, 0x88, 0x85, 0x87, 0x84, 0x88, 0x86, 0x86, 0x88, 0x86, 0x82, 0x83, 0x80, 0x98, 0x98, 0x83, 0x98, 0x92, 0xAC, 0x00, 0x00, 0x00},
	{0x00, 0xC0, 0x00, 0xC6, 0x00, 0xB3, 0x89, 0x8A, 0x8A, 0x87, 0x88, 0x87, 0x88, 0x87, 0x87, 0x84, 0x88, 0x86, 0x85, 0x87, 0x84, 0x86, 0x87, 0x84, 0x97, 0x97, 0x83, 0x8C, 0x89, 0x9D, 0x00, 0x00, 0x00},
	{0x00, 0xC3, 0x00, 0xC8, 0x00, 0xB6, 0x88, 0x8A, 0x8A, 0x86, 0x88, 0x87, 0x88, 0x86, 0x87, 0x84, 0x88, 0x87, 0x82, 0x85, 0x82, 0x86, 0x87, 0x84, 0x96, 0x96, 0x83, 0x8C, 0x89, 0x9D, 0x00, 0x00, 0x00},
	{0x00, 0xC4, 0x00, 0xCA, 0x00, 0xB8, 0x89, 0x8A, 0x8A, 0x85, 0x86, 0x85, 0x87, 0x86, 0x87, 0x84, 0x87, 0x86, 0x83, 0x87, 0x84, 0x83, 0x85, 0x82, 0x96, 0x96, 0x82, 0x8C, 0x89, 0x9D, 0x00, 0x00, 0x00},
	{0x00, 0xC8, 0x00, 0xCD, 0x00, 0xBC, 0x88, 0x89, 0x89, 0x86, 0x87, 0x87, 0x87, 0x85, 0x85, 0x83, 0x86, 0x85, 0x83, 0x86, 0x83, 0x84, 0x85, 0x82, 0x95, 0x96, 0x83, 0x8C, 0x89, 0x9D, 0x00, 0x00, 0x00},
	{0x00, 0xCA, 0x00, 0xCF, 0x00, 0xBF, 0x89, 0x89, 0x89, 0x85, 0x87, 0x86, 0x86, 0x85, 0x85, 0x84, 0x86, 0x84, 0x82, 0x86, 0x84, 0x84, 0x86, 0x82, 0x96, 0x96, 0x86, 0x94, 0x8F, 0xA9, 0x00, 0x00, 0x00},
	{0x00, 0xCD, 0x00, 0xD1, 0x00, 0xC3, 0x88, 0x89, 0x89, 0x85, 0x86, 0x85, 0x86, 0x85, 0x86, 0x83, 0x86, 0x85, 0x84, 0x87, 0x86, 0x82, 0x84, 0x7E, 0x93, 0x93, 0x83, 0x84, 0x83, 0x90, 0x00, 0x00, 0x00},
	{0x00, 0xD1, 0x00, 0xD4, 0x00, 0xC6, 0x87, 0x88, 0x88, 0x85, 0x86, 0x86, 0x85, 0x84, 0x84, 0x84, 0x87, 0x85, 0x82, 0x85, 0x83, 0x83, 0x85, 0x80, 0x93, 0x93, 0x85, 0x7C, 0x7D, 0x84, 0x00, 0x00, 0x00},
	{0x00, 0xD2, 0x00, 0xD6, 0x00, 0xC9, 0x87, 0x89, 0x88, 0x85, 0x87, 0x86, 0x85, 0x84, 0x85, 0x86, 0x86, 0x85, 0x80, 0x84, 0x81, 0x83, 0x85, 0x80, 0x93, 0x93, 0x84, 0x84, 0x83, 0x94, 0x00, 0x00, 0x00},
	{0x00, 0xD6, 0x00, 0xD9, 0x00, 0xCD, 0x88, 0x88, 0x88, 0x83, 0x85, 0x84, 0x86, 0x85, 0x86, 0x84, 0x85, 0x84, 0x80, 0x84, 0x81, 0x83, 0x85, 0x81, 0x92, 0x92, 0x84, 0x80, 0x80, 0x8E, 0x00, 0x00, 0x00},
	{0x00, 0xD9, 0x00, 0xDC, 0x00, 0xD1, 0x86, 0x88, 0x88, 0x84, 0x85, 0x85, 0x85, 0x84, 0x84, 0x84, 0x85, 0x86, 0x80, 0x82, 0x80, 0x85, 0x86, 0x82, 0x8E, 0x8F, 0x82, 0x7C, 0x7D, 0x84, 0x00, 0x00, 0x00},
	{0x00, 0xDC, 0x00, 0xDE, 0x00, 0xD5, 0x87, 0x88, 0x86, 0x83, 0x84, 0x84, 0x84, 0x84, 0x84, 0x84, 0x85, 0x84, 0x82, 0x85, 0x84, 0x84, 0x84, 0x7F, 0x8C, 0x8D, 0x7F, 0x88, 0x86, 0x97, 0x00, 0x00, 0x00},
	{0x00, 0xDE, 0x00, 0xE1, 0x00, 0xD7, 0x86, 0x87, 0x87, 0x84, 0x85, 0x84, 0x84, 0x84, 0x84, 0x84, 0x83, 0x83, 0x82, 0x83, 0x83, 0x84, 0x84, 0x80, 0x8A, 0x8C, 0x7E, 0x84, 0x83, 0x90, 0x00, 0x00, 0x00},
	{0x00, 0xE1, 0x00, 0xE4, 0x00, 0xDC, 0x86, 0x87, 0x86, 0x83, 0x84, 0x83, 0x82, 0x83, 0x83, 0x83, 0x84, 0x83, 0x81, 0x84, 0x83, 0x81, 0x82, 0x7D, 0x90, 0x8F, 0x83, 0x78, 0x7A, 0x81, 0x00, 0x00, 0x00},
	{0x00, 0xE5, 0x00, 0xE7, 0x00, 0xDF, 0x85, 0x86, 0x86, 0x83, 0x84, 0x83, 0x84, 0x84, 0x84, 0x84, 0x83, 0x83, 0x80, 0x82, 0x81, 0x83, 0x84, 0x80, 0x8C, 0x8C, 0x80, 0x7C, 0x7D, 0x87, 0x00, 0x00, 0x00},
	{0x00, 0xE7, 0x00, 0xEA, 0x00, 0xE4, 0x86, 0x85, 0x85, 0x82, 0x84, 0x84, 0x82, 0x83, 0x82, 0x83, 0x83, 0x83, 0x81, 0x83, 0x82, 0x80, 0x82, 0x7D, 0x8C, 0x8C, 0x81, 0x78, 0x7A, 0x81, 0x00, 0x00, 0x00},
	{0x00, 0xE6, 0x00, 0xE9, 0x00, 0xE2, 0x85, 0x86, 0x86, 0x83, 0x83, 0x84, 0x82, 0x82, 0x83, 0x84, 0x83, 0x84, 0x80, 0x82, 0x81, 0x84, 0x84, 0x80, 0x86, 0x87, 0x7C, 0x80, 0x80, 0x87, 0x00, 0x00, 0x00},
	{0x00, 0xE6, 0x00, 0xE9, 0x00, 0xE2, 0x85, 0x86, 0x86, 0x83, 0x83, 0x84, 0x82, 0x82, 0x83, 0x81, 0x82, 0x83, 0x7F, 0x82, 0x80, 0x85, 0x84, 0x80, 0x89, 0x88, 0x7E, 0x77, 0x7A, 0x7A, 0x00, 0x00, 0x00},
	{0x00, 0xE8, 0x00, 0xEA, 0x00, 0xE3, 0x85, 0x85, 0x85, 0x83, 0x84, 0x83, 0x83, 0x83, 0x84, 0x83, 0x82, 0x83, 0x81, 0x82, 0x82, 0x82, 0x82, 0x7E, 0x87, 0x87, 0x7C, 0x88, 0x86, 0x93, 0x00, 0x00, 0x00},
	{0x00, 0xE7, 0x00, 0xEA, 0x00, 0xE3, 0x85, 0x85, 0x86, 0x84, 0x84, 0x82, 0x82, 0x82, 0x83, 0x82, 0x82, 0x83, 0x7F, 0x82, 0x81, 0x85, 0x84, 0x80, 0x87, 0x86, 0x7D, 0x77, 0x7A, 0x7A, 0x00, 0x00, 0x00},
	{0x00, 0xE7, 0x00, 0xEA, 0x00, 0xE3, 0x85, 0x85, 0x85, 0x82, 0x83, 0x83, 0x82, 0x83, 0x83, 0x82, 0x82, 0x83, 0x7F, 0x82, 0x81, 0x81, 0x80, 0x7D, 0x8B, 0x8A, 0x82, 0x77, 0x7A, 0x7A, 0x00, 0x00, 0x00},
	{0x00, 0xE7, 0x00, 0xEA, 0x00, 0xE3, 0x85, 0x85, 0x85, 0x82, 0x82, 0x83, 0x82, 0x82, 0x82, 0x83, 0x81, 0x83, 0x81, 0x83, 0x81, 0x82, 0x80, 0x7E, 0x87, 0x86, 0x7F, 0x7B, 0x7D, 0x7D, 0x00, 0x00, 0x00},
	{0x00, 0xE7, 0x00, 0xEA, 0x00, 0xE3, 0x85, 0x85, 0x85, 0x82, 0x82, 0x83, 0x81, 0x81, 0x81, 0x84, 0x82, 0x84, 0x80, 0x81, 0x81, 0x83, 0x83, 0x7F, 0x88, 0x86, 0x80, 0x7B, 0x7D, 0x7D, 0x00, 0x00, 0x00},
	{0x00, 0xEA, 0x00, 0xEC, 0x00, 0xE5, 0x84, 0x84, 0x84, 0x83, 0x83, 0x83, 0x82, 0x82, 0x82, 0x81, 0x82, 0x82, 0x7F, 0x7F, 0x80, 0x83, 0x83, 0x83, 0x88, 0x86, 0x86, 0x7B, 0x7D, 0x7D, 0x00, 0x00, 0x00},
	{0x00, 0xED, 0x00, 0xEF, 0x00, 0xE9, 0x83, 0x84, 0x84, 0x82, 0x82, 0x83, 0x81, 0x81, 0x81, 0x82, 0x82, 0x82, 0x80, 0x80, 0x81, 0x80, 0x80, 0x81, 0x88, 0x86, 0x86, 0x7B, 0x7D, 0x7D, 0x00, 0x00, 0x00},
	{0x00, 0xF1, 0x00, 0xF2, 0x00, 0xEE, 0x82, 0x83, 0x82, 0x82, 0x82, 0x83, 0x81, 0x81, 0x81, 0x81, 0x82, 0x82, 0x80, 0x81, 0x81, 0x82, 0x82, 0x82, 0x84, 0x83, 0x83, 0x7B, 0x7D, 0x7D, 0x00, 0x00, 0x00},
	{0x00, 0xF5, 0x00, 0xF6, 0x00, 0xF2, 0x82, 0x82, 0x82, 0x81, 0x81, 0x82, 0x80, 0x80, 0x80, 0x80, 0x81, 0x81, 0x80, 0x81, 0x81, 0x82, 0x82, 0x82, 0x84, 0x83, 0x83, 0x7B, 0x7D, 0x7D, 0x00, 0x00, 0x00},
	{0x00, 0xF9, 0x00, 0xFA, 0x00, 0xF8, 0x81, 0x82, 0x82, 0x81, 0x81, 0x81, 0x81, 0x81, 0x82, 0x7F, 0x7F, 0x7F, 0x81, 0x81, 0x81, 0x80, 0x80, 0x80, 0x82, 0x81, 0x80, 0x80, 0x80, 0x83, 0x00, 0x00, 0x00},
	{0x00, 0xFC, 0x00, 0xFD, 0x00, 0xFC, 0x80, 0x81, 0x81, 0x81, 0x80, 0x81, 0x81, 0x81, 0x81, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x82, 0x81, 0x80, 0x7B, 0x7D, 0x7D, 0x00, 0x00, 0x00},
	{0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x00, 0x00, 0x00},
};

static int s6e3fa2_nv_read_enable(struct s6e3fa2_ctx *ctx, bool enable, bool send_both)
{
	/* Vendor driver calls this "nv-read-enable-cmds" */
	struct mipi_dsi_device *dsi = ctx->dsi;
	u8 cmd_bytes[3];
	u8 firstbyte1, firstbyte2;
	int ret;
	/* We need to send 2 commands, 3 bytes long each.
	 * First byte depends on panel type, byte 2 and 3 depend on enable/disable.
	 */
	firstbyte1 = 0xf0;
	switch (ctx->subtype)
	{
	case PANEL_S6E3FA2:
		firstbyte2 = 0xfc;
		break;
	case PANEL_EA8064G:
		firstbyte2 = 0xf1;
		break;
	default:
		return -ENODEV;
	}

	if (enable)
		cmd_bytes[1] = cmd_bytes[2] = 0x5a;
	else
		cmd_bytes[1] = cmd_bytes[2] = 0xa5;

	/* Send 1st command */
	cmd_bytes[0] = firstbyte1;
	dsi_generic_write_array(dsi, cmd_bytes);
	/* Send 2nd command, can be optional for S6E3FA2 */
	/* For PANEL_EA8064G - always send */
	if (send_both || (ctx->subtype == PANEL_EA8064G)) {
		cmd_bytes[0] = firstbyte2;
		dsi_generic_write_array(dsi, cmd_bytes);
	}

	return 0;
}

static int s6e3fa2_write_aid_control(struct s6e3fa2_ctx *ctx, int candela)
{
	int ret;
	struct mipi_dsi_device *dsi = ctx->dsi;
	int aid_sequence_idx;
	u8 aid_sequence[AID_SEQUENCE_LEN + 1]; /* +1 byte for command id */
	const u8 *aid_seq;

	/* Determine which sequence to send */
	aid_sequence_idx = map_candela_to_aid[candela];

	switch (ctx->subtype) {
	case PANEL_S6E3FA2:
		aid_seq = seq_s6e3fa2_aid[aid_sequence_idx];
		break;
	case PANEL_EA8064G:
		aid_seq = seq_ea8064g_aid[aid_sequence_idx];
		break;
	default:
		return -ENODEV;
	}

	aid_sequence[0] = S6E3FA2_AID_CONTROL; /*0xb2*/
	memcpy(&aid_sequence[1], aid_seq, AID_SEQUENCE_LEN);

	dsi_generic_write_array(dsi, aid_sequence);

	return 0;
}

static int s6e3fa2_write_elvss(struct s6e3fa2_ctx *ctx, int candela)
{
	int ret;
	struct mipi_dsi_device *dsi = ctx->dsi;
	int elvss_sequence_idx;
	u8 elvss_sequence[ELVSS_SEQUENCE_LEN + 1]; /* +1 byte for command id */
	const u8 *elvss_seq;

	/* Determine which sequence to send */
	elvss_sequence_idx = map_candela_to_elvss[candela];

	switch (ctx->subtype) {
	case PANEL_S6E3FA2:
		elvss_seq = seq_s6e3fa2_elvss[elvss_sequence_idx];
		break;
	case PANEL_EA8064G:
		elvss_seq = seq_ea8064g_elvss[elvss_sequence_idx];
		break;
	default:
		return -ENODEV;
	}

	elvss_sequence[0] = S6E3FA2_ELVSS_CONTROL; /*0xb6*/
	memcpy(&elvss_sequence[1], elvss_seq, ELVSS_SEQUENCE_LEN);

	dsi_generic_write_array(dsi, elvss_sequence);

	return 0;
}

static int s6e3fa2_write_gamma(struct s6e3fa2_ctx *ctx, int candela)
{
	int ret;
	struct mipi_dsi_device *dsi = ctx->dsi;
	u8 gamma_sequence[GAMMA_SEQUENCE_LEN + 1]; /* 33 +1 byte for command id */
	const u8 *gamma_seq;

	/* Gamma sequence is directly indexed by candela value */
	switch (ctx->subtype) {
	case PANEL_S6E3FA2:
		gamma_seq = seq_s6e3fa2_lux[candela];
		break;
	case PANEL_EA8064G:
		gamma_seq = seq_ea8064g_lux[candela];
		break;
	default:
		return -ENODEV;
	}

	gamma_sequence[0] = S6E3FA2_GAMMA_CONTROL; /*0xca*/
	memcpy(&gamma_sequence[1], gamma_seq, GAMMA_SEQUENCE_LEN);

	dsi_generic_write_array(dsi, gamma_sequence);

	return 0;
}

static int s6e3fa2_write_apply_gamma(struct s6e3fa2_ctx *ctx)
{
	/* Vendor driver: Gamma, LTPS(AID) update */
	dsi_generic_write_seq(ctx->dsi, 0xf7, 0x03);
	if (ctx->subtype == PANEL_S6E3FA2) /* S6E3FA2 has additional command */
		dsi_generic_write_seq(ctx->dsi, 0xf7, 0x00);
	return 0;
}

static int s6e3fa2_set_brightness(struct backlight_device *bldev)
{
	struct s6e3fa2_ctx *ctx = bl_get_data(bldev);
	const int candela = bldev->props.brightness;

	s6e3fa2_nv_read_enable(ctx, true, false);
	s6e3fa2_write_aid_control(ctx, candela);
	s6e3fa2_write_elvss(ctx, candela);
	s6e3fa2_write_gamma(ctx, candela);
	s6e3fa2_write_apply_gamma(ctx);
	s6e3fa2_nv_read_enable(ctx, false, false);

	return 0;
}

#ifdef ENABLE_LCD_ID_AUTODETECT
static int s6e3fa2_check_lcd_type(struct s6e3fa2_ctx *ctx)
{
	struct mipi_dsi_device *dsi = ctx->dsi;
	u8 id1, id2, id3;
	unsigned int lcd_id;
	int ret;

	ret = s6e3fa2_dsi_dcs_read1(dsi, S6E3FA2_READ_ID1, &id1);
	if (ret < 0) return ret;
	ret = s6e3fa2_dsi_dcs_read1(dsi, S6E3FA2_READ_ID2, &id2);
	if (ret < 0) return ret;
	ret = s6e3fa2_dsi_dcs_read1(dsi, S6E3FA2_READ_ID3, &id3);
	if (ret < 0) return ret;

	lcd_id = id1 << 16 | id2 << 8 | id3;

	switch (lcd_id) {
	case LCD_ID_S6E3FA2:
		dev_info(&ctx->dsi->dev, "detected S6E3FA2 panel (ID: 0x%x)\n", lcd_id);
		ctx->subtype = PANEL_S6E3FA2;
		break;
	case LCD_ID_EA8064G:
		dev_info(&ctx->dsi->dev, "detected EA8064G panel (ID: 0x%x)\n", lcd_id);
		ctx->subtype = PANEL_EA8064G;
		break;
	default:
		dev_warn(&ctx->dsi->dev, "detected unsupported panel ID: 0x%x\n", lcd_id);
		ctx->subtype = PANEL_UNKNOWN;
		break;
	}

	return 0;
}
#endif

static int s6e3fa2_init(struct s6e3fa2_ctx *ctx)
{
	struct mipi_dsi_device *dsi = ctx->dsi;
	struct device *dev = &dsi->dev;
	int ret;

	dsi->mode_flags |= MIPI_DSI_MODE_LPM;

	s6e3fa2_nv_read_enable(ctx, true, true);

	if (ctx->subtype == PANEL_S6E3FA2) {
		/* Configure MIPI Interface (Single DSI) */
		dsi_dcs_write_seq(dsi, 0xf2);
		dsi_dcs_write_seq(dsi, 0xf9);

		usleep_range(5000, 6000);

		ret = mipi_dsi_dcs_exit_sleep_mode(dsi);
		if (ret < 0) {
			dev_err(dev, "Failed to exit sleep mode: %d\n", ret);
			return ret;
		};
		msleep(20); /* Sleep out, wait 20ms(0x14) */
		
		s6e3fa2_write_gamma(ctx, S6E3FA2_MAX_BRIGHTNESS);
		s6e3fa2_write_aid_control(ctx, S6E3FA2_MAX_BRIGHTNESS);

		/* CAPS ELVSS Set */
		dsi_generic_write_seq(dsi, S6E3FA2_ELVSS_CONTROL,
				0x98, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03,
				0x55, 0x54, 0x20, 0x00, 0x0a, 0xaa, 0xaf, 0x0f,
				0x02, 0x22, 0x22, 0x10);

		/* Unknown command: 16 frame Averaging (0x41) */
		dsi_generic_write_seq(dsi, 0xb5, 0x41);

		s6e3fa2_write_apply_gamma(ctx);

		/* TE Vsync ON  */
		dsi_generic_write_seq(dsi, 0xb0, 0x02);
		dsi_generic_write_seq(dsi, 0xfd, 0x0a);
		dsi_generic_write_seq(dsi, 0xfe, 0x80);
		dsi_generic_write_seq(dsi, 0xfe, 0x00);

		mipi_dsi_dcs_set_tear_on(dsi, MIPI_DSI_DCS_TEAR_MODE_VBLANK);

		/* Touch Hsync Enable */
		dsi_generic_write_seq(dsi, 0xbd, 0x05, 0x02, 0x02);
	} else if(ctx->subtype == PANEL_EA8064G) {
		s6e3fa2_write_gamma(ctx, S6E3FA2_MAX_BRIGHTNESS);
		s6e3fa2_write_aid_control(ctx, S6E3FA2_MAX_BRIGHTNESS);

		/* CAPS ELVSS Set */
		dsi_generic_write_seq(dsi, S6E3FA2_ELVSS_CONTROL, 0x58, 0x84);

		/* Unknown command: 16 frame Averaging (0x21) */
		dsi_generic_write_seq(dsi, 0xb5, 0x21);
		
		/* Disable high brightness mode */
		dsi_generic_write_seq(dsi, MIPI_DCS_WRITE_CONTROL_DISPLAY, 0x00);
		
		s6e3fa2_write_apply_gamma(ctx);

		/* TE Vsync ON  */
		dsi_generic_write_seq(dsi, 0xb0, 0x01);
		dsi_generic_write_seq(dsi, 0xb8, 0x04);
		dsi_generic_write_seq(dsi, 0xba, 0x32, 0x30, 0x01);

		mipi_dsi_dcs_set_tear_on(dsi, MIPI_DSI_DCS_TEAR_MODE_VBLANK);

		/* Touch Hsync Enable */
		dsi_generic_write_seq(dsi, 0xb9, 0x05, 0x17, 0x1b);
		
		ret = mipi_dsi_dcs_exit_sleep_mode(dsi);
		if (ret < 0) {
			dev_err(dev, "Failed to exit sleep mode: %d\n", ret);
			return ret;
		};
		/* sleep 120ms after exiting sleep mode */
		msleep(120);
	} else {
		dev_warn(&dsi->dev, "init: skipped init sequence, unknown panel!\n");
	}

	s6e3fa2_nv_read_enable(ctx, false, true);

	return 0;
}

static int s6e3fa2_power_on(struct s6e3fa2_ctx *ctx)
{
	int ret;

	ret = regulator_bulk_enable(ARRAY_SIZE(ctx->supplies), ctx->supplies);
	if (ret < 0) {
		dev_err(&ctx->dsi->dev, "Failed to enable regulators: %d\n", ret);
		return ret;
	}
	msleep(30);

	/* send reset pulse */
	gpiod_set_value_cansleep(ctx->reset_gpio, 0);
	usleep_range(5000, 6000);
	gpiod_set_value_cansleep(ctx->reset_gpio, 1);
	usleep_range(5000, 6000);
	gpiod_set_value_cansleep(ctx->reset_gpio, 0);
	usleep_range(7000, 8000);

	msleep(60); /* This is important! panel init seq does not work without this delay! */

	return 0;
}

static int s6e3fa2_power_off(struct s6e3fa2_ctx *ctx)
{
	int ret;

	gpiod_set_value(ctx->reset_gpio, 1);

	ret = regulator_bulk_disable(ARRAY_SIZE(ctx->supplies), ctx->supplies);
	if (ret < 0)
		return ret;

	return 0;
}

static int s6e3fa2_enable(struct drm_panel *panel)
{
	struct s6e3fa2_ctx *ctx = panel_to_s6e3fa2(panel);
	struct mipi_dsi_device *dsi = ctx->dsi;
	int ret;

	if (ctx->enabled)
		return 0;

	ret = mipi_dsi_dcs_exit_sleep_mode(dsi);
	if (ret < 0) {
		dev_err(&dsi->dev, "Failed to exit sleep mode: %d\n", ret);
		return ret;
	};
	msleep(120);

	ret = mipi_dsi_dcs_set_display_on(dsi);
	if (ret < 0) {
		dev_err(&dsi->dev, "Failed to set display on: %d\n", ret);
		return ret;
	}
	msleep(50);

	backlight_enable(ctx->bl_dev);

	ctx->enabled = true;
	return 0;
}

static int s6e3fa2_disable(struct drm_panel *panel)
{
	struct s6e3fa2_ctx *ctx = panel_to_s6e3fa2(panel);
	struct mipi_dsi_device *dsi = ctx->dsi;
	int ret;

	if (!ctx->enabled)
		return 0;

	backlight_disable(ctx->bl_dev);

	dsi->mode_flags &= ~MIPI_DSI_MODE_LPM;

	ret = mipi_dsi_dcs_set_display_off(dsi);
	if (ret < 0) {
		dev_err(&dsi->dev, "Failed to set display off: %d\n", ret);
		return ret;
	}
	usleep_range(10000, 11000);

	ret = mipi_dsi_dcs_enter_sleep_mode(dsi);
	if (ret < 0) {
		dev_err(&dsi->dev, "Failed to enter sleep mode: %d\n", ret);
		return ret;
	}

	ctx->enabled = false;
	return 0;
}

static int s6e3fa2_prepare(struct drm_panel *panel)
{
	struct s6e3fa2_ctx *ctx = panel_to_s6e3fa2(panel);
	struct device *dev = &ctx->dsi->dev;
	int ret;

	if (ctx->prepared)
		return 0;

	ret = s6e3fa2_power_on(ctx);
	if (ret < 0) {
		dev_err(dev, "prepare: failed to power on the panel!\n");
		return ret;
	}

#ifdef ENABLE_LCD_ID_AUTODETECT
	ret = s6e3fa2_check_lcd_type(ctx);
	if (ret < 0)
		dev_warn(dev, "Failed to check LCD type!\n");
#endif

	ret = s6e3fa2_init(ctx);
	if (ret < 0) {
		dev_err(dev, "Failed to initialize panel: %d\n", ret);
		s6e3fa2_power_off(ctx);
		return ret;
	}

	ctx->prepared = true;
	return 0;
}

static int s6e3fa2_unprepare(struct drm_panel *panel)
{
	struct s6e3fa2_ctx *ctx = panel_to_s6e3fa2(panel);
	struct device *dev = &ctx->dsi->dev;
	int ret;

	if (!ctx->prepared)
		return 0;

	ret = s6e3fa2_power_off(ctx);
	if (ret < 0)
		dev_err(dev, "Failed to power off panel: %d\n", ret);

	ctx->prepared = false;
	return 0;
}

/* Resolution, size and timing values are the same for both panels. */
static const struct drm_display_mode s6e3fa2_display_mode = {
	.clock = (1080 + 162 + 10 + 36) * (1920 + 13 + 2 + 3) * 60 / 1000,
	.hdisplay = 1080,
	.hsync_start = 1080 + 162,
	.hsync_end = 1080 + 162 + 10,
	.htotal = 1080 + 162 + 10 + 36,
	.vdisplay = 1920,
	.vsync_start = 1920 + 13,
	.vsync_end = 1920 + 13 + 2,
	.vtotal = 1920 + 13 + 2 + 3,
	.width_mm = 65,
	.height_mm = 115,
};

static int s6e3fa2_get_modes(struct drm_panel *panel, struct drm_connector *connector)
{
	struct drm_display_mode *mode;

	mode = drm_mode_duplicate(connector->dev, &s6e3fa2_display_mode);
	if (!mode)
		return -ENOMEM;

	drm_mode_set_name(mode);

	mode->type = DRM_MODE_TYPE_DRIVER | DRM_MODE_TYPE_PREFERRED;
	connector->display_info.width_mm = mode->width_mm;
	connector->display_info.height_mm = mode->height_mm;
	connector->display_info.panel_orientation = DRM_MODE_PANEL_ORIENTATION_NORMAL;
	drm_mode_probed_add(connector, mode);

	return 1;
}

static const struct drm_panel_funcs s6e3fa2_panel_funcs = {
	.prepare = s6e3fa2_prepare,
	.enable = s6e3fa2_enable,
	.disable = s6e3fa2_disable,
	.unprepare = s6e3fa2_unprepare,
	.get_modes = s6e3fa2_get_modes,
};

static const struct backlight_ops s6e3fa2_backlight_ops = {
	.update_status	= s6e3fa2_set_brightness,
};

static int s6e3fa2_backlight_register(struct s6e3fa2_ctx *ctx)
{
	struct backlight_properties props = {
		.type		= BACKLIGHT_RAW,
		.scale		= BACKLIGHT_SCALE_LINEAR,
		.brightness	= S6E3FA2_MAX_BRIGHTNESS,
		.max_brightness = S6E3FA2_MAX_BRIGHTNESS,
	};
	struct device *dev = &ctx->dsi->dev;
	int ret = 0;

	ctx->bl_dev = devm_backlight_device_register(dev, "panel", dev, ctx,
						     &s6e3fa2_backlight_ops,
						     &props);
	if (IS_ERR(ctx->bl_dev)) {
		ret = PTR_ERR(ctx->bl_dev);
		dev_err(dev, "error registering backlight device (%d)\n", ret);
	}

	return ret;
}

static int s6e3fa2_probe(struct mipi_dsi_device *dsi)
{
	struct device *dev = &dsi->dev;
	struct s6e3fa2_ctx *ctx;
	int ret;

	ctx = devm_kzalloc(dev, sizeof(*ctx), GFP_KERNEL);
	if (!ctx)
		return -ENOMEM;

	ctx->supplies[0].supply = "iovdd";
	ctx->supplies[1].supply = "vddr";
	ret = devm_regulator_bulk_get(dev, ARRAY_SIZE(ctx->supplies),
				      ctx->supplies);
	if (ret < 0)
		return dev_err_probe(dev, ret, "Failed to get regulators\n");

	ctx->reset_gpio = devm_gpiod_get(dev, "reset", GPIOD_OUT_HIGH);
	if (IS_ERR(ctx->reset_gpio))
		return dev_err_probe(dev, PTR_ERR(ctx->reset_gpio),
				     "Failed to get reset-gpios\n");

	/* We don't know panel variant yet */
	ctx->subtype = PANEL_UNKNOWN;
#ifndef ENABLE_LCD_ID_AUTODETECT
	/* Not using lcd id autodetect - detect by compatible */
	ctx->subtype = (enum s6e3fa2_panel_subtype)of_device_get_match_data(dev);
	dev_info(dev, "s6e3fa2_probe: panel subtype = %u\n", ctx->subtype);
#endif

	ctx->dsi = dsi;
	mipi_dsi_set_drvdata(dsi, ctx);

	dsi->lanes = 4;
	dsi->format = MIPI_DSI_FMT_RGB888;
	dsi->mode_flags = MIPI_DSI_MODE_VIDEO_BURST |
			  MIPI_DSI_CLOCK_NON_CONTINUOUS;

	drm_panel_init(&ctx->panel, dev, &s6e3fa2_panel_funcs, DRM_MODE_CONNECTOR_DSI);

	ret = s6e3fa2_backlight_register(ctx);
	if (ret < 0)
		return ret;

	drm_panel_add(&ctx->panel);

	ret = mipi_dsi_attach(dsi);
	if (ret < 0) {
		dev_err(dev, "Failed to attach to DSI host: %d\n", ret);
		drm_panel_remove(&ctx->panel);
		return ret;
	}

	return 0;
}

static int s6e3fa2_remove(struct mipi_dsi_device *dsi)
{
	struct s6e3fa2_ctx *ctx = mipi_dsi_get_drvdata(dsi);
	int ret;

	ret = mipi_dsi_detach(dsi);
	if (ret < 0)
		dev_err(&dsi->dev, "Failed to detach from DSI host: %d\n", ret);

	drm_panel_remove(&ctx->panel);

	return 0;
}

#ifdef ENABLE_LCD_ID_AUTODETECT
static const struct of_device_id samsung_s6e3fa2_of_match[] = {
	{ .compatible = "samsung,s6e3fa2" },
	{ /* sentinel */ }
};
#else /* detect by compatible string */
static const struct of_device_id samsung_s6e3fa2_of_match[] = {
	{ .compatible = "samsung,s6e3fa2-full", .data = (void *)PANEL_S6E3FA2 },
	{ .compatible = "samsung,s6e3fa2-ea8064g", .data = (void *)PANEL_EA8064G },
	{ /* sentinel */ }
};
#endif /* ENABLE_LCD_ID_AUTODETECT */

MODULE_DEVICE_TABLE(of, samsung_s6e3fa2_of_match);

static struct mipi_dsi_driver samsung_s6e3fa2_driver = {
	.probe = s6e3fa2_probe,
	.remove = s6e3fa2_remove,
	.driver = {
		.name = "panel-samsung-s6e3fa2",
		.of_match_table = samsung_s6e3fa2_of_match,
	},
};
module_mipi_dsi_driver(samsung_s6e3fa2_driver);

MODULE_AUTHOR("Iskren Chernev <iskren.chernev@gmail.com>");
MODULE_AUTHOR("Alexey Minnekhanov <alexeymin@postmarketos.org>");
MODULE_DESCRIPTION("DRM driver for Samsung S6E3FA2 panel");
MODULE_LICENSE("GPL v2");
